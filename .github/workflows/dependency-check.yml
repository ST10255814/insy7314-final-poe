name: Dependency Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Monday at 6 AM
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  frontend-dependency-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check if Frontend Package Files Exist
        id: check-frontend
        run: |
          if [ -f "frontend/package.json" ]; then
            echo "package-exists=true" >> $GITHUB_OUTPUT
          else
            echo "package-exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No package.json found in frontend directory"
          fi
      
      - name: Setup Node.js
        if: steps.check-frontend.outputs.package-exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Frontend Dependencies
        if: steps.check-frontend.outputs.package-exists == 'true'
        run: |
          cd frontend
          npm install
        continue-on-error: true
      
      - name: Run Frontend Audit
        if: steps.check-frontend.outputs.package-exists == 'true'
        run: |
          cd frontend
          npm audit --audit-level moderate --json > frontend-audit.json
        continue-on-error: true
      
      - name: Check for High/Critical Vulnerabilities - Frontend
        if: steps.check-frontend.outputs.package-exists == 'true'
        run: |
          cd frontend
          if [ -f "frontend-audit.json" ]; then
            # Check if jq is available and audit file has content
            if command -v jq >/dev/null 2>&1 && [ -s "frontend-audit.json" ]; then
              HIGH_VULNS=$(cat frontend-audit.json | jq '.metadata.vulnerabilities.high // 0')
              CRITICAL_VULNS=$(cat frontend-audit.json | jq '.metadata.vulnerabilities.critical // 0')
              TOTAL_HIGH_CRITICAL=$((HIGH_VULNS + CRITICAL_VULNS))
              echo "High vulnerabilities: $HIGH_VULNS"
              echo "Critical vulnerabilities: $CRITICAL_VULNS"
              echo "Total High/Critical vulnerabilities: $TOTAL_HIGH_CRITICAL"
              
              if [ "$TOTAL_HIGH_CRITICAL" -gt 0 ]; then
                echo "âŒ High or critical vulnerabilities found in frontend dependencies!"
                npm audit --audit-level high
                exit 1
              else
                echo "âœ… No high or critical vulnerabilities found in frontend dependencies"
              fi
            else
              echo "âœ… No vulnerabilities found or unable to parse audit results"
            fi
          else
            echo "âœ… No audit file generated - likely no vulnerabilities"
          fi
      
      - name: Skip Frontend Check
        if: steps.check-frontend.outputs.package-exists == 'false'
        run: |
          echo "âš ï¸ Skipping frontend dependency check - no package.json found"
          echo "To enable frontend checks, ensure frontend/package.json exists"
      
      - name: Upload Frontend Audit Results
        uses: actions/upload-artifact@v4
        if: always() && steps.check-frontend.outputs.package-exists == 'true'
        with:
          name: frontend-audit-report
          path: frontend/frontend-audit.json

  backend-dependency-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check if Backend Package Files Exist
        id: check-backend
        run: |
          if [ -f "backend/package.json" ]; then
            echo "package-exists=true" >> $GITHUB_OUTPUT
          else
            echo "package-exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No package.json found in backend directory"
          fi
      
      - name: Setup Node.js
        if: steps.check-backend.outputs.package-exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Backend Dependencies
        if: steps.check-backend.outputs.package-exists == 'true'
        run: |
          cd backend
          npm install
        continue-on-error: true
      
      - name: Run Backend Audit
        if: steps.check-backend.outputs.package-exists == 'true'
        run: |
          cd backend
          npm audit --audit-level moderate --json > backend-audit.json
        continue-on-error: true
      
      - name: Check for High/Critical Vulnerabilities - Backend
        if: steps.check-backend.outputs.package-exists == 'true'
        run: |
          cd backend
          if [ -f "backend-audit.json" ]; then
            if command -v jq >/dev/null 2>&1 && [ -s "backend-audit.json" ]; then
              HIGH_VULNS=$(cat backend-audit.json | jq '.metadata.vulnerabilities.high // 0')
              CRITICAL_VULNS=$(cat backend-audit.json | jq '.metadata.vulnerabilities.critical // 0')
              TOTAL_HIGH_CRITICAL=$((HIGH_VULNS + CRITICAL_VULNS))
              echo "High vulnerabilities: $HIGH_VULNS"
              echo "Critical vulnerabilities: $CRITICAL_VULNS"
              echo "Total High/Critical vulnerabilities: $TOTAL_HIGH_CRITICAL"
              
              if [ "$TOTAL_HIGH_CRITICAL" -gt 0 ]; then
                echo "âŒ High or critical vulnerabilities found in backend dependencies!"
                npm audit --audit-level high
                exit 1
              else
                echo "âœ… No high or critical vulnerabilities found in backend dependencies"
              fi
            else
              echo "âœ… No vulnerabilities found or unable to parse audit results"
            fi
          else
            echo "âœ… No audit file generated - likely no vulnerabilities"
          fi
      
      - name: Skip Backend Check
        if: steps.check-backend.outputs.package-exists == 'false'
        run: |
          echo "âš ï¸ Skipping backend dependency check - no package.json found"
          echo "To enable backend checks, ensure backend/package.json exists"
      
      - name: Upload Backend Audit Results
        uses: actions/upload-artifact@v4
        if: always() && steps.check-backend.outputs.package-exists == 'true'
        with:
          name: backend-audit-report
          path: backend/backend-audit.json

  owasp-dependency-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Java for OWASP Dependency Check
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      
      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        id: dependency-check
        with:
          project: 'insy7314-payment-app'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
            --failOnCVSS 7
            --exclude "**/node_modules/**"
            --exclude "**/test/**"
            --exclude "**/tests/**"
            --exclude "**/.git/**"
        continue-on-error: true
      
      - name: Upload OWASP Dependency Check Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: owasp-dependency-check-report
          path: reports/
      
      - name: Publish OWASP Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('reports/dependency-check-report.sarif') != ''
        with:
          sarif_file: reports/dependency-check-report.sarif

  license-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install license-checker
        run: npm install -g license-checker
      
      - name: Check Frontend Licenses
        run: |
          if [ -f "frontend/package.json" ]; then
            cd frontend
            npm install || echo "Failed to install frontend dependencies"
            license-checker --json --out ../frontend-licenses.json || echo "No packages found"
            license-checker --summary || echo "No packages to summarize"
            cd ..
          else
            echo "No frontend/package.json found, skipping frontend license check"
            echo "{}" > frontend-licenses.json
          fi
      
      - name: Check Backend Licenses
        run: |
          if [ -f "backend/package.json" ]; then
            cd backend
            npm install || echo "Failed to install backend dependencies"
            license-checker --json --out ../backend-licenses.json || echo "No packages found"
            license-checker --summary || echo "No packages to summarize"
            cd ..
          else
            echo "No backend/package.json found, skipping backend license check"
            echo "{}" > backend-licenses.json
          fi
      
      - name: Check for Forbidden Licenses
        run: |
          echo "Checking for forbidden licenses..."
          FORBIDDEN_LICENSES=("GPL-2.0" "GPL-3.0" "AGPL-1.0" "AGPL-3.0")
          
          for license in "${FORBIDDEN_LICENSES[@]}"; do
            if grep -q "$license" frontend-licenses.json backend-licenses.json 2>/dev/null; then
              echo "âŒ Forbidden license found: $license"
              exit 1
            fi
          done
          echo "âœ… No forbidden licenses found"
      
      - name: Upload License Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-reports
          path: |
            frontend-licenses.json
            backend-licenses.json

  dependency-summary:
    runs-on: ubuntu-latest
    needs: [frontend-dependency-check, backend-dependency-check, owasp-dependency-check, license-check]
    if: always()
    steps:
      - name: Generate Dependency Summary
        run: |
          echo "# ðŸ“‹ Dependency Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” Scan Results" >> $GITHUB_STEP_SUMMARY
          
          # Check job results
          if [ "${{ needs.frontend-dependency-check.result }}" == "success" ]; then
            echo "- âœ… Frontend dependency check: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Frontend dependency check: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.backend-dependency-check.result }}" == "success" ]; then
            echo "- âœ… Backend dependency check: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Backend dependency check: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.owasp-dependency-check.result }}" == "success" ]; then
            echo "- âœ… OWASP dependency check: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ OWASP dependency check: COMPLETED WITH WARNINGS" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.license-check.result }}" == "success" ]; then
            echo "- âœ… License check: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ License check: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Reports Available" >> $GITHUB_STEP_SUMMARY
          echo "All dependency check reports have been uploaded as artifacts and are available for download." >> $GITHUB_STEP_SUMMARY
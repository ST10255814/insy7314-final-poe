version: 2.1

orbs:
  node: circleci/node@5.1.0

# Define workflows
workflows:
  version: 2
  ci-cd-pipeline:
    jobs:
      - security-scan
      - backend-tests:
          requires:
            - security-scan
      - sonarcloud-analysis:
          requires:
            - backend-tests
      - build-and-deploy:
          requires:
            - sonarcloud-analysis
          filters:
            branches:
              only: 
                - main
                - develop

# Define jobs
jobs:
  # Security scanning job
  security-scan:
    docker:
      - image: cimg/node:18.17
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: |
            cd backend && npm ci
            cd ../frontend && npm ci
      - run:
          name: Run npm audit (Backend)
          command: |
            cd backend
            npm audit --audit-level=moderate --production || true
            npm audit --json > audit-results-backend.json || true
      - run:
          name: Run npm audit (Frontend)
          command: |
            cd frontend
            npm audit --audit-level=moderate --production || true
            npm audit --json > audit-results-frontend.json || true
      - run:
          name: Install Snyk CLI
          command: |
            sudo npm install -g snyk@latest
            snyk --version
      - run:
          name: Authenticate Snyk
          command: snyk auth $SNYK_TOKEN
      - run:
          name: Snyk Test Backend
          command: |
            cd backend
            snyk test --severity-threshold=high || true
            snyk monitor || true
      - run:
          name: Snyk Test Frontend
          command: |
            cd frontend
            snyk test --severity-threshold=high || true
            snyk monitor || true
      - run:
          name: OWASP Dependency Check
          command: |
            # Download OWASP dependency check
            wget https://github.com/jeremylong/DependencyCheck/releases/download/v8.4.0/dependency-check-8.4.0-release.zip
            unzip dependency-check-8.4.0-release.zip
            # Run dependency check on both projects
            ./dependency-check/bin/dependency-check.sh --project "INSY7314-Backend" --scan backend/ --format JSON --out backend-dependency-check.json || true
            ./dependency-check/bin/dependency-check.sh --project "INSY7314-Frontend" --scan frontend/ --format JSON --out frontend-dependency-check.json || true
      - store_artifacts:
          path: backend-dependency-check.json
      - store_artifacts:
          path: frontend-dependency-check.json
      - store_artifacts:
          path: backend/audit-results-backend.json
      - store_artifacts:
          path: frontend/audit-results-frontend.json

  # Backend testing job
  backend-tests:
    docker:
      - image: cimg/node:18.17
      - image: mongo:6.0
        environment:
          MONGO_INITDB_DATABASE: test
    steps:
      - checkout
      - run:
          name: Install Backend Dependencies
          command: cd backend && npm ci
      - run:
          name: Run ESLint
          command: cd backend && npm run lint
      - run:
          name: Run Backend Tests
          command: cd backend && npm run test:ci
      - run:
          name: Upload Backend Coverage to Codecov
          command: |
            cd backend
            bash <(curl -s https://codecov.io/bash) -f coverage/lcov.info -F backend
      - store_test_results:
          path: backend/coverage
      - store_artifacts:
          path: backend/coverage
      - persist_to_workspace:
          root: .
          paths:
            - backend/coverage

  # SonarCloud analysis job
  sonarcloud-analysis:
    docker:
      - image: cimg/node:18.17
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Install SonarScanner
          command: |
            wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.8.0.2856-linux.zip
            unzip sonar-scanner-cli-4.8.0.2856-linux.zip
            sudo mv sonar-scanner-4.8.0.2856-linux /opt/sonar-scanner
            sudo ln -s /opt/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner
      - run:
          name: Run SonarCloud Scan
          command: |
            sonar-scanner \
              -Dsonar.projectKey=$SONAR_PROJECT_KEY \
              -Dsonar.organization=$SONAR_ORG_KEY \
              -Dsonar.host.url=https://sonarcloud.io \
              -Dsonar.login=$SONAR_TOKEN \
              -Dsonar.sources=. \
              -Dsonar.exclusions=**/node_modules/**,**/coverage/**,**/build/**,**/dist/** \
              -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov.info

  # Build and deploy job
  build-and-deploy:
    docker:
      - image: cimg/node:18.17
    steps:
      - checkout
      - run:
          name: Build Backend
          command: |
            cd backend
            npm ci --production
            echo "âœ… Backend application built successfully"
      - run:
          name: Build Frontend
          command: |
            cd frontend
            npm ci
            npm run build
            echo "âœ… Frontend application built successfully"
      - run:
          name: Package Applications
          command: |
            # Create deployment packages
            mkdir -p deployment/backend deployment/frontend
            cp -r backend/* deployment/backend/
            cp -r frontend/build/* deployment/frontend/
            echo "âœ… Applications packaged for deployment"
      - store_artifacts:
          path: deployment/
      - run:
          name: Deploy to Staging (Simulated)
          command: |
            echo "ðŸš€ Deploying to staging environment..."
            echo "Backend files: deployment/backend/"
            echo "Frontend build: deployment/frontend/"
            echo "âœ… Deployment completed successfully!"

  # Performance testing job (optional)
  performance-tests:
    docker:
      - image: cimg/node:18.17
    steps:
      - checkout
      - run:
          name: Install k6
          command: |
            sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
            echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
            sudo apt-get update
            sudo apt-get install k6
      - run:
          name: Run Performance Tests
          command: |
            echo "Running performance tests..."
            # Add your k6 performance test scripts here
            echo "Performance tests completed!"

  # OWASP ZAP Security Testing (optional)
  owasp-zap-security:
    docker:
      - image: owasp/zap2docker-stable
    steps:
      - checkout
      - run:
          name: Run OWASP ZAP Baseline Scan
          command: |
            zap-baseline.py -t http://localhost:3000 -J zap-report.json || true
      - store_artifacts:
          path: zap-report.json